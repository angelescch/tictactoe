#include "types.h"
#include "user.h"

#define BOARD_SIZE 3
#define CELL_MAX (BOARD_SIZE * BOARD_SIZE - 1)

#define false 0
#define true 1

/*                                  WONEJO
0x2A, 0x2A, 0x2A, 0x2A, 0x00, 0x00, 0x2A, 0x00, 0x00, 0x2A, 0x2A, 0x2A, 0x2A
0x2A, 0x2A, 0x2A, 0x00, 0xFF, 0x00, 0x2A, 0x00, 0xFF, 0x00, 0x2A, 0x2A, 0x2A
0x2A, 0x2A, 0x00, 0xFF, 0xFF, 0x00, 0x2A, 0x00, 0xFF, 0xFF, 0x00, 0x2A, 0x2A
0x2A, 0x2A, 0x00, 0xFF, 0xFF, 0x00, 0x2A, 0x00, 0xFF, 0xFF, 0x00, 0x2A, 0x2A
0x2A, 0x2A, 0x00, 0xFF, 0xFF, 0x00, 0x2A, 0x00, 0xFF, 0xFF, 0x00, 0x2A, 0x2A
0x2A, 0x2A, 0x00, 0xFF, 0xFF, 0x00, 0x2A, 0x00, 0xFF, 0xFF, 0x00, 0x2A, 0x2A
0x2A, 0x2A, 0x00, 0xFF, 0xFF, 0x00, 0x2A, 0x00, 0xFF, 0xFF, 0x00, 0x2A, 0x2A
0x2A, 0x2A, 0x00, 0xFF, 0x08, 0x00, 0x2A, 0x00, 0x08, 0xFF, 0x00, 0x2A, 0x2A
0x2A, 0x2A, 0x00, 0xFF, 0x08, 0x00, 0x2A, 0x00, 0x08, 0xFF, 0x00, 0x2A, 0x2A
0x2A, 0x2A, 0x2A, 0x00, 0x08, 0x08, 0x00, 0x08, 0x08, 0x00, 0x2A, 0x2A, 0x2A
0x2A, 0x2A, 0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x2A, 0x2A
0x2A, 0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x2A
0x2A, 0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x2A
0x00, 0x08, 0x08, 0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x08, 0x08, 0x00
0x00, 0x08, 0x08, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x08, 0x08, 0x00
0x00, 0x08, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x08, 0x00
0x2A, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x2A
0x2A, 0x2A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2A, 0x2A
*/

//Dibuja el tablero actual a partir de un arreglo de char
void
print_board(uchar board[BOARD_SIZE][BOARD_SIZE])
{
  int cell = 0;
  printf("\t .................................................\n");
  for (int row = 0; row < BOARD_SIZE; ++row) {
    for (int column = 0; column < BOARD_SIZE; ++column) {
      printf("\t | %d: %c ", cell, board[row][column]);
      ++cell;
    }
    printf("\t | \n");
    printf("\t .................................................\n");
  }
}

void
init_board(void)
{
    for(int x=69; x < 250; x++){
        for(int y = 9; y < 190; y++){
            plotpixel(x,y,15); //cambiar color
        }
    }
    
}

void
update_cell(int row, int column, uchar turn)
{

}

char
get_winner(uchar board[BOARD_SIZE][BOARD_SIZE], int row, int column)
{
  char winner = '-';
  int winner_diag1_O = true, winner_diag2_O = true, winner_diag1_X = true, winner_diag2_X = true;
  int winner_row_O = true, winner_col_O = true, winner_row_X = true, winner_col_X = true;

  for (int k = 0; k < BOARD_SIZE; k++){
    winner_col_O &&= board[row][k] == 'O';
    winner_row_O &&= board[k][column] == 'O';
    winner_col_X &&= board[row][k] == 'X';
    winner_row_X &&= board[k][column] == 'X';
  }

  for (int k = 0; k < BOARD_SIZE; k++) {
    winner_diag1_O &&= board[k][k] == 'O';
    winner_diag2_O &&= board[BOARD_SIZE][BOARD_SIZE - k] == 'O';
    winner_diag1_X &&= board[k][k] == 'X';
    winner_diag2_X &&= board[BOARD_SIZE][BOARD_SIZE - k] == 'X';
  }

  if (winner_diag1_O || winner_diag2_O || winner_row_O || winner_col_O) 
    winner = 'O';
  if (winner_diag1_X || winner_diag2_X || winner_row_X || winner_col_X) 
    winner = 'X';

  return winner;
}

int
main(void)
{
  printf("TicTacToe\n");
  
  uchar board[BOARD_SIZE][BOARD_SIZE] = {
    { '-', '-', '-' },
    { '-', '-', '-' },
    { '-', '-', '-' }
  };
  uchar turn = 'X';
  uchar winner = '-';
  int cell, free_cells = 9;

  modeswitch(1);
  init_board();

  while (winner == '-' && has_free_cell(board)) {
    printf("\nTurno %c - Elija posición (número del 1 al 9): ", turn);
    int scanf_result = scanf("%d", &cell);
    if (scanf_result <= 0) {
      panic("Error reading cell\n");
    }
    cell--;
    if (cell >= 0 && cell <= CELL_MAX) {
      int row = cell / BOARD_SIZE;
      int column = cell % BOARD_SIZE;
      if (board[row][column] == '-') {
        free_cells--;
        board[row][column] = turn;
        turn = turn == 'X' ? 'O' : 'X';
        winner = get_winner(board, row, column);
      } else {
        printf("\nCelda ocupada!\n");
      }
      } else {
        printf("\nCelda inválida!\n");
      }
    print_board(board);
  }
  if (winner == '-') {
    printf("Empate!\n");
  } else {
    printf("Ganó %c\n", winner);
  }
  exit();
}
